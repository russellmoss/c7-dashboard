services:
  # Web Service (Next.js Frontend)
  - type: web
    name: milea-estate-dashboard
    env: node
    plan: starter
    nodeVersion: "18.20.0"
    buildCommand: |
      echo "üöÄ Starting Next.js frontend build..."
      NODE_ENV=production npm install
      NODE_ENV=production SKIP_INTEGRATION_TESTS=true CI=true npm run build:render
      npm run verify:render
      echo "‚úÖ Frontend build completed successfully"
      echo "üìÅ Checking standalone build..."
      ls -la .next/standalone/ || echo "‚ö†Ô∏è Standalone directory not found"
      echo "üìÅ Checking static assets..."
      ls -la .next/static/ || echo "‚ö†Ô∏è Static directory not found"
    startCommand: npm start
    healthCheckPath: /api/health
    envVars:
      # Production Environment
      - key: NODE_ENV
        value: production
      - key: CI
        value: "true"
      
      # Next.js Build Configuration
      - key: SKIP_INTEGRATION_TESTS
        value: "true"
      - key: NEXT_DISABLE_STATIC_GENERATION
        value: "true"
      - key: NEXT_DISABLE_OPTIMIZATION
        value: "true"
      - key: NEXT_DISABLE_CACHE
        value: "true"
      - key: NEXT_DISABLE_STATIC_EXPORT
        value: "true"
      
      # Database Configuration
      - key: MONGODB_URI
        sync: false
      
      # External Services
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_PHONE_NUMBER
        sync: false
      - key: RESEND_API_KEY
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: JWT_SECRET
        sync: false
    autoDeploy: true

  # Background Worker Service (Node.js Backend)
  - type: worker
    name: milea-estate-worker
    env: node
    plan: starter
    nodeVersion: "18.20.0"
    buildCommand: |
      echo "üîß Starting backend worker build..."
      NODE_ENV=production npm install
      NODE_ENV=production SKIP_INTEGRATION_TESTS=true CI=true npm run build:worker:prod
      echo "‚úÖ Backend worker build completed successfully"
    startCommand: NODE_ENV=production npm run start:worker
    envVars:
      # Production Environment
      - key: NODE_ENV
        value: production
      - key: CI
        value: "true"
      
      # Test Configuration (Skip tests during deployment)
      - key: SKIP_INTEGRATION_TESTS
        value: "true"
      
      # Database Configuration
      - key: MONGODB_URI
        sync: false
      
      # External Services
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_PHONE_NUMBER
        sync: false
      - key: RESEND_API_KEY
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: JWT_SECRET
        sync: false
    autoDeploy: true

# Deployment Notes:
# - Frontend: Next.js app with dynamic rendering, no static generation
# - Backend: Node.js worker with cron jobs for communications and KPI generation
# - Database: MongoDB Atlas with persistent connections
# - External Services: Twilio (SMS), Resend (Email), Anthropic (AI)
# - Build Process: Tests skipped during production builds
# - Health Checks: Frontend health check at /api/health
